<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Aplicación Naruto Monolito</title>
<style>
  body { font-family: Arial; background: #f5f5f5; margin: 20px; }
  h1, h2 { color: #222; }
  h2 { background: #222; color: #fff; padding: 8px; border-radius: 6px; }
  section { background: white; padding: 15px; border-radius: 6px; margin-bottom: 20px; box-shadow: 0 0 5px #aaa; }
  label { display: block; margin-top: 5px; }
  input, select, textarea { width: 100%; margin-bottom: 8px; padding: 5px; }
  button { background: #007bff; color: white; padding: 6px 12px; border: none; border-radius: 5px; cursor: pointer; }
  button:hover { background: #0056b3; }
  .item { border-bottom: 1px solid #ddd; padding: 8px 0; }
  .item:last-child { border-bottom: none; }
</style>
</head>
<body>

<h1>- Aplicación Monolítica de Gestión Ninja -</h1>

<!-- ================== ALDEAS ================== -->
<section id="aldeas">
  <h2>Aldeas</h2>
  <button onclick="listarAldeas()">Actualizar Aldeas</button>
  <div id="listaAldeas"></div>
</section>

<!-- ================== JUTSUS ================== -->
<section id="jutsus">
  <h2>Jutsus</h2>
  <form id="formJutsu">
    <label>Nombre:</label>
    <input type="text" id="jutsuNombre" required>

    <label>Tipo:</label>
    <input type="text" id="jutsuTipo" required>

    <label>Daño:</label>
    <input type="number" id="jutsuDanio" required>

    <label>Chakra:</label>
    <input type="number" id="jutsuChakra" required>

    <button type="submit">Registrar Jutsu</button>
  </form>

  <button onclick="listarJutsus()">Listar Jutsus</button>
  <div id="listaJutsus"></div>
</section>

<!-- ================== NINJAS ================== -->
<section id="ninjas">
  <h2>Ninjas</h2>
  <form id="formNinja">
    <label>Nombre:</label>
    <input type="text" id="ninjaNombre" required>

    <label>Rango Ninja:</label>
    <select id="ninjaRango">
      <option value="GENIN">GENIN</option>
      <option value="CHUNIN">CHUNIN</option>
      <option value="JONIN">JONIN</option>
    </select>

    <label>Ataque:</label>
    <input type="number" id="ninjaAtaque" required>

    <label>Defensa:</label>
    <input type="number" id="ninjaDefensa" required>

    <label>Chakra:</label>
    <input type="number" id="ninjaChakra" required>

    <label>Aldea:</label>
    <select id="ninjaAldea"></select>

    <button type="submit">Registrar Ninja</button>
  </form>

  <button onclick="listarNinjas()">Listar Ninjas</button>
  <div id="listaNinjas"></div>

  <h3>Asignar Jutsu a Ninja</h3>
  <label>Ninja:</label>
  <select id="ninjaSelectJutsu"></select>

  <label>Jutsu:</label>
  <select id="jutsuSelect"></select>

  <button onclick="asignarJutsu()">Asignar</button>
</section>

<!-- ================== MISIONES ================== -->
<section id="misiones">
  <h2>Misiones</h2>
  <form id="formMision">
    <label>Nombre:</label>
    <input type="text" id="misionNombre" required>

    <label>Descripción:</label>
    <textarea id="misionDescripcion" required></textarea>

    <label>Rango Misión:</label>
    <select id="misionRango">
      <option value="D">D</option>
      <option value="C">C</option>
      <option value="B">B</option>
      <option value="A">A</option>
      <option value="S">S</option>
    </select>

    <label>Recompensa:</label>
    <input type="number" id="misionRecompensa" required>

    <label>Rango Ninja mínimo:</label>
    <select id="misionRangoMin">
      <option value="GENIN">GENIN</option>
      <option value="CHUNIN">CHUNIN</option>
      <option value="JONIN">JONIN</option>
    </select>

    <button type="submit">Registrar Misión</button>
  </form>

  <button onclick="listarMisiones()">Listar Misiones</button>
  <div id="listaMisiones"></div>

  <h3>Asignar Ninja a Misión</h3>
  <label>Misión:</label>
  <select id="misionSelectMision"></select>

  <label>Ninja:</label>
  <select id="ninjaSelectMision"></select>

  <button onclick="asignarNinjaAMision()">Asignar</button>
  <div id="resultadoAsignacion"></div>
</section>

<!-- ================== REPORTES ================== -->
<section id="reportes">
  <h2>Generar Reportes</h2>
  <button onclick="exportar('txt')">Exportar TXT</button>
  <button onclick="exportar('json')">Exportar JSON</button>
  <button onclick="exportar('xml')">Exportar XML</button>
</section>

<script>
const api = '/api';

// ================== ALDEAS ==================
async function listarAldeas() {
  const res = await fetch(`${api}/aldeas`);
  const data = await res.json();

  const contenedor = document.getElementById('listaAldeas');
  contenedor.innerHTML = data.map(a => `
    <div class="item">
      <strong>${a.nombre}</strong> — <em>${a.nacion}</em><br>
      Ninjas: ${a.ninjas && a.ninjas.length ? a.ninjas.join(', ') : 'Sin ninjas registrados'}
    </div>
  `).join('');

  const sel = document.getElementById('ninjaAldea');
  sel.innerHTML = '';
  data.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a.id;
    opt.textContent = a.nombre + ' (' + a.nacion + ')';
    sel.appendChild(opt);
  });
}

// ================== NINJAS ==================
document.getElementById('formNinja').addEventListener('submit', async e => {
  e.preventDefault();
  const body = {
    nombre: ninjaNombre.value,
    rango: ninjaRango.value,
    ataque: parseInt(ninjaAtaque.value),
    defensa: parseInt(ninjaDefensa.value),
    chakra: parseInt(ninjaChakra.value),
    aldea: { id: parseInt(ninjaAldea.value) }
  };
  await fetch(`${api}/ninjas`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  listarNinjas();
});

async function listarNinjas() {
  const res = await fetch(`${api}/ninjas`);
  const data = await res.json();

  const contenedor = document.getElementById('listaNinjas');
  contenedor.innerHTML = data.map(n => `
    <div class="item">
      <strong>${n.nombre}</strong> (${n.rango})<br>
      Aldea: ${n.aldeaNombre ? n.aldeaNombre : 'Sin aldea'}<br>
      Ataque: ${n.ataque}, Defensa: ${n.defensa}, Chakra: ${n.chakra}<br>
      Jutsus: ${n.jutsus && n.jutsus.length ? n.jutsus.join(', ') : 'Ninguno'}
    </div>
  `).join('');

  // Actualizar dropdowns
  const selJutsu = document.getElementById('ninjaSelectJutsu');
  const selMision = document.getElementById('ninjaSelectMision');
  selJutsu.innerHTML = '';
  selMision.innerHTML = '';
  data.forEach(n => {
    const opt1 = document.createElement('option');
    opt1.value = n.id;
    opt1.textContent = n.nombre + ' (' + n.rango + ')';
    selJutsu.appendChild(opt1);
    selMision.appendChild(opt1.cloneNode(true));
  });
}

async function asignarJutsu() {
  const ninjaId = ninjaSelectJutsu.value;
  const jutsuId = jutsuSelect.value;
  await fetch(`${api}/ninjas/${ninjaId}/asignar-jutsu/${jutsuId}`, { method: 'POST' });
  alert('Jutsu asignado correctamente');
  listarNinjas();
}

// ================== JUTSUS ==================
document.getElementById('formJutsu').addEventListener('submit', async e => {
  e.preventDefault();
  const body = {
    nombre: jutsuNombre.value,
    tipo: jutsuTipo.value,
    danio: parseInt(jutsuDanio.value),
    chakra: parseInt(jutsuChakra.value)
  };
  await fetch(`${api}/jutsus`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  listarJutsus();
});

async function listarJutsus() {
  const res = await fetch(`${api}/jutsus`);
  const data = await res.json();
  const contenedor = document.getElementById('listaJutsus');
  contenedor.innerHTML = data.map(j => `
    <div class="item">
      <strong>${j.nombre}</strong> (${j.tipo})<br>
      Daño: ${j.danio}, Chakra: ${j.chakra}
    </div>
  `).join('');

  const sel = document.getElementById('jutsuSelect');
  sel.innerHTML = '';
  data.forEach(j => {
    const opt = document.createElement('option');
    opt.value = j.id;
    opt.textContent = j.nombre + ' (' + j.tipo + ')';
    sel.appendChild(opt);
  });
}

// ================== MISIONES ==================
document.getElementById('formMision').addEventListener('submit', async e => {
  e.preventDefault();
  const body = {
    nombre: misionNombre.value,
    descripcion: misionDescripcion.value,
    rango: misionRango.value, 
    recompensa: parseInt(misionRecompensa.value),
    rangoMinimo: misionRangoMin.value
  };
  await fetch(`${api}/misiones`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
  listarMisiones();
});

async function listarMisiones() {
  const res = await fetch(`${api}/misiones`);
  const data = await res.json();

  const contenedor = document.getElementById('listaMisiones');
  contenedor.innerHTML = data.map(m => `
    <div class="item">
      <strong>${m.nombre}</strong> — Rango ${m.rango}<br>
      Descripción: ${m.descripcion}<br>
      Recompensa: ${m.recompensa} ryō<br>
      Rango mínimo: ${m.rangoMinimo}<br>
      Participantes: ${m.participantes && m.participantes.length ? m.participantes.join(', ') : 'Sin participantes'}
    </div>
  `).join('');

  const sel = document.getElementById('misionSelectMision');
  sel.innerHTML = '';
  data.forEach(m => {
    const opt = document.createElement('option');
    opt.value = m.id;
    opt.textContent = m.nombre + ' (' + m.rango + ')';
    sel.appendChild(opt);
  });
}

async function asignarNinjaAMision() {
  const misionId = misionSelectMision.value;
  const ninjaId = ninjaSelectMision.value;
  const res = await fetch(`${api}/misiones/${misionId}/asignar/${ninjaId}`, { method: 'POST' });
  if (res.ok) {
    document.getElementById('resultadoAsignacion').textContent = 'Ninja asignado correctamente';
  } else {
    const text = await res.text();
    document.getElementById('resultadoAsignacion').textContent = 'Error: ' + text;
  }
  listarMisiones();
}

// ================== REPORTES ==================
function exportar(tipo) {
  window.open(`${api}/reportes/${tipo}`, '_blank');
}

// ================== INICIALIZACIÓN ==================
listarAldeas();
listarJutsus();
listarNinjas();
listarMisiones();
</script>
</body>
</html>
